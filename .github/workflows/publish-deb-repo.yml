name: Publish Debian Repository

on:
  workflow_run:
    workflows: ["Build, Scan, Package, Sign, and Release K8s Tools"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

jobs:
  publish_repo:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Create gh-pages branch if it doesn't exist
        run: |
          if [ ! -d "gh-pages/.git" ]; then
            echo "Creating new gh-pages branch..."
            mkdir -p gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin https://github.com/${{ github.repository }}.git
            cd ..
          fi

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg

      - name: Import GPG key
        run: |
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          # Export public key in the root directory
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --export -a > gh-pages/public_key.asc
          # Also create a copy with .txt extension as a workaround
          cp gh-pages/public_key.asc gh-pages/public_key.txt

      - name: Create APT repository metadata
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create necessary directories
          mkdir -p gh-pages/dists/stable/main/binary-amd64
          
          # Create a Packages file that points to GitHub releases
          echo "Creating Packages file with redirect to releases..."
          
          # Get all .deb files from releases and create Packages entries
          > gh-pages/dists/stable/main/binary-amd64/Packages
          
          gh api repos/${{ github.repository }}/releases --jq '.[] | .assets[] | select(.name | endswith(".deb"))' | jq -r '{name, browser_download_url, size}' | while IFS= read -r line; do
            name=$(echo "$line" | jq -r '.name')
            url=$(echo "$line" | jq -r '.browser_download_url')
            size=$(echo "$line" | jq -r '.size')
            
            # Extract version from filename (e.g., k8s-tools_25.08.0-1_amd64.deb -> 25.08.0-1)
            version=$(echo "$name" | sed -n 's/k8s-tools_\(.*\)_amd64\.deb/\1/p')
            
            # Create a minimal Packages entry
            cat >> gh-pages/dists/stable/main/binary-amd64/Packages << ENDPKG
Package: k8s-tools
Version: ${version}
Architecture: amd64
Maintainer: Martin Stadler <martin@sansnom.co>
Depends: ca-certificates
Section: utils
Priority: optional
Size: ${size}
Filename: ${url}
Description: Statically linked Kubernetes CLI tools
 This package contains kubectl, helm, jq, skopeo, oras, cosign, and flux.
 All binaries are statically linked for maximum compatibility.

ENDPKG
          done

      - name: Compress Packages file
        run: |
          cd gh-pages
          gzip -9c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz

      - name: Create Release file
        run: |
          cd gh-pages/dists/stable
          cat > Release << EOF
          Origin: sansnom-co
          Label: K8s Tools
          Suite: stable
          Codename: stable
          Version: 1.0
          Architectures: amd64
          Components: main
          Description: Statically linked Kubernetes CLI tools
          Date: $(date -Ru)
          EOF
          
          # Add checksums
          echo "MD5Sum:" >> Release
          find main -type f | while read -r file; do
            md5sum "$file" | sed 's|main/|./main/|' >> Release
          done
          
          echo "SHA256:" >> Release
          find main -type f | while read -r file; do
            sha256sum "$file" | sed 's|main/|./main/|' >> Release
          done

      - name: Sign Release file
        run: |
          cd gh-pages/dists/stable
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --detach-sign --armor -o Release.gpg Release
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --clearsign -o InRelease Release

      - name: Create static files
        run: |
          # Copy scripts from main branch
          cp main/scripts/create-repo-index.sh gh-pages/
          cp main/scripts/setup-repo-files.sh gh-pages/
          
          # Run setup in gh-pages directory
          cd gh-pages
          chmod +x *.sh
          ./setup-repo-files.sh
          cd ..

      - name: Create CNAME file
        run: |
          # Only create CNAME if you have a custom domain
          # echo "your-custom-domain.com" > gh-pages/CNAME

      - name: Commit and push to gh-pages
        run: |
          cd gh-pages
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git diff --quiet && git diff --staged --quiet || git commit -m "Update Debian repository [skip ci]"
          git push origin gh-pages --force